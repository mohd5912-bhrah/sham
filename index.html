<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0c7b93">
<title>Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©ğŸ”</title>
<style>
body{
  font-family: Tahoma, sans-serif;
  background:#f4f6f8;
  margin:0;
  padding:15px;
}
h2{margin:0 0 15px 0; color:#0c7b93}
.container{display:flex; flex-wrap:wrap; gap:15px;}
.box{
  background:#fff;
  border-radius:10px;
  padding:10px;
  flex:1;
  min-width:280px;
  box-shadow:0 2px 6px rgba(0,0,0,.06);
}
#authors{
  max-height: 70vh;      /* ØªØ­Ø¯ÙŠØ¯ Ø§Ø±ØªÙØ§Ø¹ Ù†Ø³Ø¨ÙŠ */
  overflow-y: auto;      /* ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ */
  padding-right: 5px;
  background:#f9ffd9;
}

#cats{
  max-height: 70vh;      /* ØªØ­Ø¯ÙŠØ¯ Ø§Ø±ØªÙØ§Ø¹ Ù†Ø³Ø¨ÙŠ */
  overflow-y: auto;      /* ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ */
  padding-right: 5px;
  background:#f0ddec;
}

#books{
  max-height: 70vh;      /* ØªØ­Ø¯ÙŠØ¯ Ø§Ø±ØªÙØ§Ø¹ Ù†Ø³Ø¨ÙŠ */
  overflow-y: auto;      /* ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ */
  padding-right: 5px;
  background:#b4e3ed;
}
.search{
  width:97%;
  padding:7px;
  margin-bottom:10px;
  border-radius:6px;
  border:1px solid #ccc;
  box-sizing:border-box;
}
.item{
  padding:6px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.item:hover{background:#f0f7fa;}
.badge{
  background:#0c7b93;
  color:#fff;
  font-size:12px;
  padding:2px 6px;
  border-radius:10px;
}
#cats .item, #authors .item {
  padding: 5px 8px;       
  font-size: 13px;        
  border-bottom:1px solid #eee;
  border-radius:6px;
  margin-bottom:4px;
  box-sizing:border-box;
  background:#fff;
  cursor:pointer;
  transition: transform 0.2s, background 0.2s;
}

#cats .item:hover, #authors .item:hover {
  background:#e0f0f5;
  transform: translateY(-1px);
}

@media screen and (min-width: 400px) {
  #cats .item, #authors .item {
    display: inline-block;      
    width: calc(50% - 8px);     
    margin-right: 8px;
  }
}

@media screen and (min-width: 700px) {
  #cats .item, #authors .item {
    width: calc(33.33% - 10px); 
  }
}

/* ===== Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙƒØªØ¨ ===== */
.book-card{
  background:#fff;
  border-radius:12px;
  margin-bottom:15px;
  overflow:hidden;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
  transition: transform .2s, box-shadow .2s;
}
.book-card:hover{
  transform:translateY(-4px);
  box-shadow:0 6px 12px rgba(0,0,0,.15);
}
.book-header{
  padding:12px 15px;
  cursor:pointer;
  font-weight:bold;
  font-size:16px;
  color:#0c7b93;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#e8f2f5;
  transition: background .2s;
}
.book-header:hover{background:#d0e6eb}
.book-info{
  padding:10px 15px;
  background:#f9f9f9;
  border-top:1px solid #ddd;
  display:none;
  white-space:pre-line;
  line-height:1.5;
  color:#333;
}
.toggle-icon{
  font-weight:bold;
  transition: transform .2s;
}
.toggle-icon.open{transform:rotate(90deg);}
.highlight{
  background:yellow;
}

/* Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ */
#backBtn{
  display:none;
  margin-bottom:10px;
  padding:7px 12px;
  background:#0c7b93;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
#backBtn:hover{background:#095a6b;}
</style>
</head>
<body>

<h2 id="mainTitle">ğŸ“š Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©</h2>

<div class="container" id="mainContainer">

  <div class="box" id="catsBox">
    <h3>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3>
    <input class="search" id="catSearch" placeholder="Ø¨Ø­Ø«...">
    <div id="cats"></div>
  </div>

  <div class="box" id="authorsBox">
    <h3>Ø§Ù„Ù…Ø¤Ù„ÙÙˆÙ†</h3>
    <input class="search" id="authorSearch" placeholder="Ø¨Ø­Ø«...">
    <div id="authors"></div>
  </div>

  <div class="box" style="flex:2" id="booksBox">
    <button id="backBtn">Ø±Ø¬ÙˆØ¹</button>
    <h3>Ø§Ù„ÙƒØªØ¨</h3>
    <input class="search" id="bookSearch" placeholder="Ø¨Ø­Ø«...">
    <div id="books"></div>
  </div>

</div>

<script>
let currentCat=null;
let currentAuthor=null;
let data = { books:[] , categories:[] };

// ===== Ù‚Ø±Ø§Ø¡Ø© JSON =====
fetch("library.json")
  .then(res => res.json())
  .then(json => {
    data = json;
	
	 const total = data.books.length;
    document.getElementById("mainTitle").innerHTML =
      `Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© - <font color=red>ğŸ“š Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØªØ¨ ${total} </font>ÙƒØªØ§Ø¨`;
	
    renderCategories();
    renderAuthors();
    renderBooks();
  })
  .catch(err => console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", err));

// ===== Ø§Ù„Ø£Ù‚Ø³Ø§Ù… =====
function renderCategories(){
 const q=document.getElementById('catSearch').value.toLowerCase();
 const catsDiv=document.getElementById('cats');
 catsDiv.innerHTML="";
 data.categories.filter(c=>c.name.toLowerCase().includes(q)).forEach(c=>{
  const count=data.books.filter(b=>b.category_id==c.id).length;
  const div=document.createElement('div');
  div.className="item";
  div.innerHTML=`${c.name} <span class="badge">${count}</span>`;
  div.onclick=()=>{
    currentCat=c.id; currentAuthor=null;
    showBooksOnly();
    renderBooks();
  };
  catsDiv.appendChild(div);
 });
}

// ===== Ø§Ù„Ù…Ø¤Ù„ÙÙˆÙ† =====
function renderAuthors(){
 const q=document.getElementById('authorSearch').value.toLowerCase();
 const authorsDiv=document.getElementById('authors');
 authorsDiv.innerHTML="";
 const map={};
 data.books.forEach(b=>map[b.author]=(map[b.author]||0)+1);
 Object.keys(map).filter(a=>a.toLowerCase().includes(q)).forEach(a=>{
  const div=document.createElement('div');
  div.className="item";
  div.innerHTML=`${a} <span class="badge">${map[a]}</span>`;
  div.onclick=()=>{
    currentAuthor=a; currentCat=null;
    showBooksOnly();
    renderBooks();
  };
  authorsDiv.appendChild(div);
 });
}

// ===== Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ù†Øµ =====
function highlight(text, q){
  if(!q) return text;
  const re=new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,"gi");
  return text.replace(re,'<span class="highlight">$1</span>');
}

// ===== Ø¹Ø±Ø¶ Ø§Ù„ÙƒØªØ¨ ÙÙ‚Ø· ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…/Ø§Ù„Ù…Ø¤Ù„ÙÙŠÙ† =====
function showBooksOnly(){
  document.getElementById('catsBox').style.display='none';
  document.getElementById('authorsBox').style.display='none';
  document.getElementById('backBtn').style.display='inline-block';
}

// ===== Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ =====
document.getElementById('backBtn').addEventListener('click',()=>{
  document.getElementById('catsBox').style.display='block';
  document.getElementById('authorsBox').style.display='block';
  document.getElementById('backBtn').style.display='none';
  currentCat=null;
  currentAuthor=null;
  document.getElementById('bookSearch').value='';
  renderBooks();
});

// ===== Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ ÙÙŠ Ø§Ù„ÙƒØªØ¨ =====
document.getElementById("bookSearch")
  .addEventListener("keyup", function(){
    liveSearchBooks(this.value);
});


function liveSearchBooks(term){

  const q = term.toLowerCase();

  const result = data.books.filter(b => {

    // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø¤Ù„Ù Ø¥Ù† ÙƒØ§Ù†Øª Ù…ÙØ¹Ù„Ø©
    if(currentCat && b.category_id != currentCat) return false;
    if(currentAuthor && b.author != currentAuthor) return false;

    // Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙƒØªØ§Ø¨Ø© Ø´ÙŠØ¡ Ø§Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
    if(!q) return true;

    // ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ title ÙÙ‚Ù€Ù€Ø·
    return b.title.toLowerCase().includes(q);

  });

  renderBooks(result);

}




// ===== Ø¹Ø±Ø¶ Ø§Ù„ÙƒØªØ¨ =====
function renderBooks(filteredBooks=null){
  const q = document.getElementById('bookSearch').value.toLowerCase();
  const booksDiv = document.getElementById('books');

  let booksToShow = filteredBooks || data.books.filter(b=>{
    if(currentCat && b.category_id != currentCat) return false;
    if(currentAuthor && b.author != currentAuthor) return false;
    if(!q) return true;
    return (
      b.title.toLowerCase().includes(q) ||
      b.author.toLowerCase().includes(q) ||
      b.info.toLowerCase().includes(q)
    );
  });

  // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ¨ Ù…Ø¹ Ø§Ù„Ø¹Ø¯Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø­Ø«
  const booksHeader = document.querySelector('.box[style*="flex:2"] h3');
  if(currentCat){
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù…Ù‡ ÙˆØ¹Ø¯Ø¯ ÙƒØªØ¨Ù‡
    const cat = data.categories.find(c => c.id == currentCat);
    const count = booksToShow.length;
    booksHeader.textContent = `Ø§Ù„ÙƒØªØ¨ ÙÙŠ ${cat.name} (${count})`;
  } else if(currentAuthor){
    booksHeader.textContent = `Ø§Ù„ÙƒØªØ¨ Ù„Ù„Ù…Ø¤Ù„Ù ${currentAuthor} (${booksToShow.length})`;
  } else {
    booksHeader.textContent = `Ø§Ù„ÙƒØªØ¨ (${booksToShow.length})`;
  }

  booksDiv.innerHTML = "";

  booksToShow.forEach(b => {
    const div = document.createElement('div');
    div.className = "book-card";
    div.innerHTML = `
      <div class="book-header">
        <span class="title">${highlight(b.title,q)}</span>
        <span class="toggle-icon">&#9654;</span>
      </div>
      <div class="book-info">
        âœï¸ ${highlight(b.author,q)}\n\n${highlight(b.info,q)}
      </div>
    `;
    const header = div.querySelector('.book-header');
    const info = div.querySelector('.book-info');
    const icon = div.querySelector('.toggle-icon');

    header.addEventListener('click',()=>{
      const visible = info.style.display=="block";
      info.style.display = visible ? "none":"block";
      icon.classList.toggle("open", !visible);
    });

    booksDiv.appendChild(div);
  });
}


// ===== Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ Ù„Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ø¤Ù„ÙÙŠÙ† =====
document.getElementById('catSearch').addEventListener('input',renderCategories);
document.getElementById('authorSearch').addEventListener('input',renderAuthors);
document.getElementById("bookSearch").addEventListener("input", () => renderBooks());

// ===== ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© =====
window.addEventListener('DOMContentLoaded', () => {

  document.getElementById('catSearch').value = '';
  document.getElementById('authorSearch').value = '';
  document.getElementById('bookSearch').value = '';

  currentCat = null;
  currentAuthor = null;
  });


if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js")
    .then(()=>console.log("PWA Ready"))
    .catch(err=>console.error("SW error", err));
}
</script>
</body>
</html>
